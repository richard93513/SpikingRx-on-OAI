# SpikingRx-on-OAI  
# 通道雜訊（SNR）控制與驗證完整技術筆記

---

# 0. 問題背景與動機

在既有的 SpikingRx-on-OAI 系統中，已完成以下流程：

- gNB ↔ UE 成功連線
- UE 端 dump 四類資料：
  1. Full-grid FFT（14×2048 complex）
  2. Demapper LLR（float32）
  3. LDPC config（json）
  4. gNB TX transport block bits
- 使用 SpikingRx 推論產生 LLR
- 外部 LDPC decoder 解碼
- 計算 BER / BLER

然而實驗中發現：

即使 LLR 對齊正確，BER/BLER 表現仍不穩定，與理論預期不符。

懷疑原因：

- 通道噪聲（SNR）未被刻意控制
- AWGN 設定未真正生效
- 通道始終處於高 SNR 狀態

因此本次目標為：

> 建立可控 AWGN 通道，並驗證噪聲確實被加入且可影響系統性能。

---

# 1. 原始系統架構與 Dump 設計

## 1.1 Full-grid Dump 設計

在 UE `nr_rx_pdsch()` 中加入 full-grid dump，並加入 slot guard：

檔名格式：

f%04d_s%02d_fullgrid_idx%06u.bin

Header 結構（16 bytes）：

(frame, slot, start_symbol, n_sym, first_sc, used_sc, rx_ant, cw)

資料內容：

- 14 OFDM symbols
- 每 symbol 2048 subcarriers
- complex16 (int16 I/Q)

---

## 1.2 其他 Dump 檔案

- demapper LLR：float32，長度 G
- LDPC config：JSON
- TX bits：gNB 原始 TB bits

---

## 1.3 為何 Dump 數量變少？

新版設計：

- 僅在 PDSCH start_symbol dump
- 每 slot 只 dump 一次

因此檔案數量下降，但 LLR 與 fullgrid 對齊正確。

---

# 2. 尋找 AWGN 控制位置

## 2.1 Repo 搜尋

在 openairinterface5g 下搜尋：

snr | noise | awgn | sigma

發現：

radio/rfsimulator/apply_channelmod.c  
channelmod_rfsimu.conf

---

## 2.2 channelmod 設定檔確認

路徑：

targets/PROJECTS/GENERIC-NR-5GC/CONF/channelmod_rfsimu.conf

gNB config 包含：

options = ("chanmod");  
@include "channelmod_rfsimu.conf"

---

## 2.3 AWGN 參數

設定檔內容：

type = "AWGN";  
noise_power_dB = X;

可透過修改 noise_power_dB 控制噪聲。

---

# 3. Runtime 驗證：確認噪聲真的被加入

## 3.1 問題

- gNB log 只顯示 AWGN activated
- 看不到實際 noise_power_dB
- UE log 也沒有顯示 SNR

因此需要直接修改程式印出實際值。

---

## 3.2 修改 rfsimulator 程式碼

檔案：

radio/rfsimulator/apply_channelmod.c

找到：

const double noise_per_sample =
  add_noise ? pow(10, channelDesc->noise_power_dB/10.0)*256 : 0;

加入：

printf("[CHANMOD] add_noise=%d noise_power_dB=%f noise_per_sample=%e\n",
       add_noise, channelDesc->noise_power_dB, noise_per_sample);

---

## 3.3 實際 Log 輸出

[CHANMOD] add_noise=1  
[CHANMOD] noise_power_dB=10.000000  
[CHANMOD] noise_per_sample=2.560000e+03  

驗證公式：

10^(10/10) * 256 = 10 * 256 = 2560

與 log 相符。

---

## 3.4 結論

- add_noise = 1 → AWGN 啟用
- noise_power_dB 成功讀取
- 噪聲確實被加入 time-domain RF stream

---

# 4. 嘗試由 Full-grid 計算 SNR_proxy

## 4.1 原始假設（錯誤）

假設：

ofdm = 2048  
used_sc = 1272  
first_sc = (2048 - 1272)/2 = 388  

定義：

SNR_proxy = 10log10(P_used / P_guard)

---

## 4.2 發現問題

改變 noise_power_dB：

- SNR_proxy 幾乎不變
- P_guard 幾乎固定

懷疑頻帶切錯。

---

# 5. 關鍵突破：頻帶位置錯誤

## 5.1 滑動窗口法

對每個 subcarrier：

p[k] = I^2 + Q^2

用長度 = used_sc 的滑動窗口掃描：

找最大能量窗口起點 k0。

結果：

真正 used band 起點 ≠ 388  
可能出現在 1400+ 並且 wrap-around。

結論：

OAI FFT 頻帶不是置中排列。

---

## 5.2 修正後結果

修正後 SNR_proxy 大幅改變。

證明原先 SNR 計算完全錯誤。

---

# 6. 為何 SNR_proxy 不反映 AWGN？

原因：

- AWGN 加在 time-domain
- fullgrid dump 在 FFT 後
- UE 內部有：
  - AGC
  - Channel estimation
  - Equalization

等化會改變信號/噪聲比例。

因此：

fullgrid SNR ≠ RF SNR

---

# 7. 系統流程與 AWGN 位置

TX bits  
  ↓  
LDPC encode  
  ↓  
OFDM  
  ↓  
rfsimulator + AWGN  ← 噪聲加入點  
  ↓  
UE RF  
  ↓  
FFT  
  ↓  
Channel estimation  
  ↓  
Equalization  
  ↓  
Fullgrid dump ← 此處  
  ↓  
Demapper LLR  
  ↓  
LDPC decode  
  ↓  
BER / BLER  

---

# 8. 實驗設計建議

## Plan A（推薦）

做 noise_power_dB sweep：

-20, -10, -5, 0, 5, 10, 15

每個點：

- 固定 MCS
- 跑 ≥2000 frames
- 統計 BLER

得到：

noise_power_dB vs BLER 曲線

若單調上升 → 通道控制成功。

---

## Plan B（若需真實 SNR）

- 將 dump 點移至 equalization 前
- 或 dump rfsimulator time-domain
- 才能計算真實 SNR

---

# 9. 已完成里程碑

- channelmod 可控 AWGN
- runtime 驗證 add_noise=1
- noise_power_dB 生效
- 修正 FFT 頻帶切法
- 釐清 fullgrid 不代表 RF SNR

---

# 10. 總結

本次工作將通道噪聲由不可控轉為可控，  
建立 runtime 驗證機制，  
並為後續 SpikingRx 性能實驗建立可重現的 SNR 維度。

下一步為完成 BLER vs noise_power_dB 曲線。
