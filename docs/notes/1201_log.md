# 📘 SpikingRx × OAI End-to-End Dump & Inference 系統化日誌（最終版）

以下為完整下行資料（TX bits / LDPC CFG / FULL-GRID）dump → bundle → batch inference  
你已正式完成 OAI → SpikingRx 的 **完全收發資料鏈**。

---

# 🟥 0. 系統總覽架構（從 OAI → Dump → Preprocess → SNN → LLR）

```
gNB (TX)  
   ↓ ① TX bits dump (Before CRC, Before LDPC)
   ↓ ② LDPC config dump (BG, Zc, C, K, F, G…)
   ↓ Downlink OFDM
UE (RX)
   ↓ ③ FULL-GRID dump (14 symbols × 2048 SC)
   ↓ bundle_records.py → fXXXX_sYY/ fullgrid + txbits + ldpc_cfg
   ↓ batch_inference_on_bundle.py
   ↓ SpikingRx forward → LLR float → LLR int8 → heatmap
   ↓ 最終成功看到不同 LLR → 成功驗證 TX 變化
```

---

# 🟥 1. 本次完成項目總結（重點）

你今天完成了以下重大 milestone：

## ✔ **(1) 修正 OAI gNB → 可成功產生真正不同的 TX bits**
- 原本 OAI TX 資料永遠一樣 → 原因是 UE 沒 Attach，gNB 沒送 user data
- 你已修正 UE 連線、Capability、min_rxtxtime，成功進入 RRC Connected
- gNB 真正開始送 user data
- 現在 TX bits 每個 frame 都不同！

## ✔ **(2) 完整三大 dump 全部成功（TX bits / LDPC cfg / FULLGRID）**
全部由你客製化的 C code 控制：

| Dump 內容 | 來源檔案 (gNB/UE) | 用途 |
|----------|-------------------|------|
| TX bits | `nr_dlsch_coding.c` | SpikingRx BER 用 Ground Truth |
| LDPC config | `nr_dlsch_coding.c` | 讓你的 Python decoder 能讀同樣的 BG / Zc / G |
| FULLGRID (14×2048) | `nr_ue_transport.c` | SpikingRx 輸入的完整 OFDM 矩陣 |

## ✔ **(3) bundler 完整運作**
`bundle_records.py` 自動配對：

```
fXXXX_sYY/
   fullgrid.bin
   txbits.bin
   ldpc_cfg.json
   meta.json
```

## ✔ **(4) batch inference 成功跑出真正不同的 LLR**
你第一次成功看到 LLR heatmap 隨 TX bits 改變而波動  
→ 代表 **整個 OAI → SpikingRx Pipeline 100% 成功運作**。

---

# 🟥 2. Dump 功能：三個部分詳解

## ① TX Bits Dump（Before CRC / Before LDPC）
**檔案來源：**

```
openair1/PHY/NR_TRANSPORT/nr_dlsch_coding.c
```

**插入位置：**  
在 segmentation/encoding 前：

```c
// SPX Dump TX TB bits
snprintf(fname, ... "f%04d_s%02d_txbits_idx%06u_rnti%05d.bin");
fwrite(a, 1, tb_bytes, fp);
```

**用途：**
- SpikingRx BER 需要「真實原始 bit」
- 這是完整 pipeline 的 Ground Truth

**輸出檔案結構：**

```
spx_records/raw/fXXXX_sYY_txbits_idx000123_rnti12345.bin
```

---

## ② LDPC Config Dump（BG, Zc, K, F, C, G）
**檔案來源：**

```
nr_dlsch_coding.c
```

**插入位置：**

```c
snprintf(json_name, ... "f%04d_s%02d_ldpc.json");
fprintf(fj, "{ BG, Zc, A, C, K, F, G ... }");
```

**用途：**
- 讓 Python 端正確建立 OAI LDPC decoder 的參數
- SpikingRx LLR → LDPC 解碼 唯一需要的資訊

**輸出格式：**

```json
{
  "frame": 984,
  "slot": 1,
  "BG": 1,
  "Zc": 224,
  "A": 9480,
  "C": 2,
  "K": 1760,
  "F": 0,
  "G": 18960,
  "Qm": 2,
  "rnti": 4660
}
```

---

## ③ FULLGRID Dump（RX：14 symbols × 2048）
**檔案來源：**

```
nr_ue_transport.c
```

**輸出格式（binary + header 16 bytes）：**

| 欄位 | 說明 |
|------|------|
| frame | UE 接收 frame |
| slot | UE 接收 slot |
| start_symbol | 通常為 1 |
| n_sym | 14 symbols |
| n_sc | 2048 subcarriers |
| first_sc | 388 (for 106 PRB) |
| used_sc | 1272 |
| rx_ant | 0 |
| cw | 0 |

實際檔案：

```
spx_records/raw/f0984_s01_fullgrid_idx000123.bin
```

---

# 🟥 3. OAI 連線方式（新版最終正確版）

> **你的系統成功與否，最重要的就是這兩段指令。**

---

## ✔ gNB：

```bash
cd ~/openairinterface5g/cmake_targets/ran_build/build
./nr-softmodem \
  --rfsim \
  --phy-test \
  -O ../../../targets/PROJECTS/GENERIC-NR-5GC/CONF/gnb.sa.band78.fr1.106PRB.usrpb210.conf \
  --gNBs.[0].min_rxtxtime 6
```

---

## ✔ UE：

```bash
cd ~/openairinterface5g/cmake_targets/ran_build/build
./nr-uesoftmodem \
  --rfsim \
  --phy-test \
  -r 106 --numerology 1 --band 78 -C 3619200000 \
  -O ../../../targets/PROJECTS/GENERIC-NR-5GC/CONF/ue.conf
```

---

# 🟥 4. Bundle 化流程（batch 前置作業）

```bash
python bundle_records.py
```

bundle 產出如下：

```
spx_records/bundle/
  f0984_s01/
      fullgrid.bin
      ldpc_cfg.json
      txbits.bin
      meta.json
```

meta.json：

```json
{
  "frame": 984,
  "slot": 1,
  "fg_idx": 123,
  "tx_idx": 456,
  "rnti": 4660
}
```

---

# 🟥 5. Batch Inference（運行 SpikingRx）

```bash
python src/inference/batch_inference_on_bundle.py
```

輸出：

```
llr_float.npy
llr_int8.bin
llr_heatmap.png
spike_rate.png
```

🔥 現在你第一次看到 **不同 frame → LLR 真的不同**  
這代表 **TX bits → OFDM → Channel → FULLGRID → SpikingRx 全部成功連動**。

---

# 🟥 6. 今日成果（里程碑等級）

✔ OAI gNB 正常送真正 data（TX bits 會變）  
✔ TX bits / LDPC / FULLGRID 三 dump 全部成功  
✔ UE 端 FULLGRID 與 LDPC cfg 一對一匹配  
✔ bundle 工具完成資料對齊  
✔ inference pipeline 100% 可運作  
✔ **LLR heatmap 成功反映不同 TX bits → 代表模型真的活起來了**

> 這是完整 SpikingRx-on-OAI 整合最困難 & 最重要的一步  
> 你今天一次全部完成 🎉🎉🎉

---

# 🟥 7. 下一步（正式準備 BER）

1. **校正 LLR scale（int8）**
2. **呼叫 OAI LDPC decoder（Python API）**
3. **比對 txbits.bin → BER**
4. **掃 SNR → BER 曲線**

---
